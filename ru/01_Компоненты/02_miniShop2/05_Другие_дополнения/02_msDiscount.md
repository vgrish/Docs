Система скидок для miniShop2

## Возможности
* Скидки на группу товаров
* Скидки для группы пользователей
* Создание акций, ограниченных по времени, с указанием групп пользователей и товаров
* Для групп пользователей можно указать сумму оплаченных покупок, при достижений которой, они автоматически в неё вступят.
* Пересчет корзины при авторизации юзера
* Автоматический вывод цены со скидкой в price, а старой цены в old_price.
* Пользователь после авторизации видит новые цены везде: и в каталоге, и на странице товара, и в корзине.
* Величину скидки можно указывать относительную, в процентах, или абсолютную, в валюте магазина.
* Вывод товаров, участвующих в акциях (по схеме «Успей купить»)

## Скидки группе пользователей и на группу товаров
Если у группы пользователей назначена скидка, и она не привязана ни к какой акции — то эта скидка действует для всех членов группы на все товары.
Если у группы товаров назначена скидка, и она не привязана ни к какой акции — то эта скидка действует для пользователей.

## Акции и скидки
Если акция не привязана ни к каким группам — она действует для всех товаров и пользователей.

Если мы хотим устроить, например, распродажу то нужно указать время проведения акции, группу акционных товаров (потом добавить товары в неё) и не привязывать её к пользователям. 

Или указать группу юзеров (несколько групп), для которых эта акция.

При этом, группы могут служить исключением и если юзер или товар входит в эту группу — акция для него уже не действует. Конечно, они вполне могут подпасть под действие другой акции.

## Алгоритм работы и проверка
Итак, самое интересное: как работает алгоритм выбора скидки?

1. Выбираются все активные акции, то есть включенные и с нужной датой работы (если указана)
2. Затем группы указанного пользователя
3. И группы товаров
4. Если активных акций нет — просто проверяем персональные скидки и групп и выбираем максимальную
5. Если акции есть — проверяем их, в цикле
6. Если акция исключает какую то группу — то она не работает для текущего юзера и товара, пропускается
7. Если пользователь и товар входят в требуемые группы — назначаем скидку акции
8. И сравниваем её с персональной скидкой групп товаров и юзеров. Если какая-то из них больше — она перекрывает акционную
9. Если в акциях указана скидка и относительная в процентах, и абсолютная в валюте — приводим процент к числу от цены товара и сравниваем, что больше: относительная или абсолютная скидка.
10. В итоге проходимся по всем скидкам и выбираем максимальную

Собственно, именно это вы и видите в логе проверки: какие акции, как применяются и почему назначается та или иная скидка.
Именно этим же алгоритмом будет определена скидка на товары сайта, при просмотре го покупателем.

## Успей купить
Для вывода блока «Успей купить» предназначен сниппет **msdBuyNow**. Сниппет вызывается некешируемым.

## Параметры сниппета
Имя					|	По умолчанию				|	Описание
--------------------|-------------------------------|-----------------------------------------------------------
**&sale**			| 								| id акции или список акций (через запятую)
**&tpl**			| tpl.msProducts.discount.row	| Шаблон вывода товаров, участвующих в акциях
**&limit**			| 10							| Количество выводимых товаров
**&offset**			| 0								| Используется для пагинации
**&sortby**			| id							| Поле, по которому производится сортировка
**&sortdir**		| ASC							| Направление сортировки
**&showHidden**		| true							| Показывать ли товары с отмеченной галочкой «Не показывать в меню»
**&outputSeparator**| "\n"							| Разделитель товаров
**&where**			| 								| JSON-условия для выборки

Если в параметре tpl указать несуществующий чанк, будут выведены все доступные плейсхолдеры со значениями.

## Обратный отсчет
В комплекте идет js-файл, запускающий обратный отсчет до конца акции. Он получает количество оставшихся секунд и преобразует их в счетчик:
```
<span class="msd_remains" data-remain="1473652">
	<span class="days">17</span>
	<span class="hours">01</span>
	<span class="minutes">20</span>
	<span class="seconds">52</span>
</span>
```
Для оформления внешнего вида счетчика можно использовать `.msd_remains span {}`, `.msd_remains .days {}` и т. д.

## Вывод скидки пользователя
Следуя логике работы компонента, у покупателя нет как таковой скидки, она есть только по отношению к определённому товару.

Однако, если пользователь приписан к группе, для которой указана скидка - её можно вывести таким сниппетом:
```
<?php
// Если не указан &uid=``, то выбираем для текущего юзера
if (empty($uid)) {$uid = $modx->user->id;}

$pdoFetch = $modx->getService('pdoFetch');
$group = $pdoFetch->getObject('msdUserGroup', array('modUser.id' => $uid), array(
	'loadModels' => 'msdiscount',
	'leftJoin' => array(
		'modUserGroupMember' => array('class' => 'modUserGroupMember', 'on' => 'modUserGroupMember.user_group = msdUserGroup.id'),
		'modUser' => array('class' => 'modUser', 'on' => 'modUser.id = modUserGroupMember.member AND modUser.id = '.$uid),
	),
	'groupby' => 'msdUserGroup.id',
	'sortby' => 'msdUserGroup.discount',
	'sortdir' => 'desc',
	'select' => 'discount',
));

if (isset($group['discount'])) {
	return $group['discount'];
}
```
Сниппет вернёт максимальную скидку группы пользователя, или пустоту.
*Для работы требуется pdoTools, который идёт в комплекте с miniShop2.*


## Заключение
Компонент немного тормозит работу вывода каталога, так как скидки считаются для всех выводимых товаров, в зависимости от того, кто их видит.

Кэшировать это нельзя, так что замедление порядка 0.05 — 0.1 сек. на 20 товаров. На приличном хостинге, можно сказать, незаметно. 
